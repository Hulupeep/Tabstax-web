contract_meta:
  id: test_integrity_defaults
  version: 2
  created_from_spec: "Specflow default — test integrity and no-mock enforcement"
  covers_reqs:
    - TEST-001
    - TEST-002
    - TEST-003
    - TEST-004
    - TEST-005
  owner: "specflow-defaults"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: test_integrity_defaults"

# Configurable defaults — override in .specflow/config.json
defaults:
  no_mock_in_e2e: true         # DEFAULT ON — E2E tests hit real services
  no_mock_in_journey: true     # DEFAULT ON — journey tests verify real behavior
  no_mock_in_unit: false       # DEFAULT OFF — unit tests may mock freely
  allowed_mock_patterns: []    # Per-project exceptions (e.g., ["stripe", "twilio"])

rules:
  non_negotiable:
    - id: TEST-001
      title: "No mocking in E2E tests"
      enabled_by_default: true
      configurable: true
      scope:
        - "tests/e2e/**/*.{ts,js,spec.ts}"
        - "!tests/e2e/**/*.helper.*"
        - "!tests/e2e/**/*.fixture.*"
      behavior:
        forbidden_patterns:
          - pattern: /jest\.mock\s*\(/
            message: "jest.mock() in E2E test — E2E tests must hit real services"
          - pattern: /vi\.mock\s*\(/
            message: "vi.mock() in E2E test — E2E tests must hit real services"
          - pattern: /sinon\.(stub|mock|fake)\s*\(/
            message: "sinon mocking in E2E test — E2E tests must hit real services"
          - pattern: /\bnock\s*\(/
            message: "nock() in E2E test — E2E tests must hit real services"
          - pattern: /\.mockImplementation\s*\(/
            message: "mockImplementation in E2E test — E2E tests must hit real services"
          - pattern: /\.mockReturnValue\s*\(/
            message: "mockReturnValue in E2E test — E2E tests must hit real services"
          - pattern: /\.mockResolvedValue\s*\(/
            message: "mockResolvedValue in E2E test — E2E tests must hit real services"
        example_violation: |
          // tests/e2e/checkout.spec.ts
          jest.mock('../services/stripe')
          test('checkout completes', async () => { ... })
        example_compliant: |
          // tests/e2e/checkout.spec.ts
          test('checkout completes against real API', async ({ page }) => {
            await page.goto('/checkout')
            // Test hits real Stripe test mode
          })

    - id: TEST-002
      title: "No mocking in journey tests"
      enabled_by_default: true
      configurable: true
      scope:
        - "tests/e2e/journey_*.spec.ts"
        - "tests/e2e/journeys/**/*.spec.ts"
      behavior:
        forbidden_patterns:
          - pattern: /\b(mock|stub|fake|spy)\b.*\b(import|require|from)\b/i
            message: "Mock import in journey test — journeys verify real user behavior"
          - pattern: /\b(jest|vi|sinon)\.(mock|stub|fake|spy)/
            message: "Mocking framework used in journey test — journeys must be real"
        example_violation: |
          // tests/e2e/journey_signup.spec.ts
          vi.mock('@/lib/supabase')
        example_compliant: |
          // tests/e2e/journey_signup.spec.ts
          test('J-SIGNUP: user completes registration', async ({ page }) => {
            // All calls hit real Supabase
          })

    - id: TEST-003
      title: "No silent test anti-patterns"
      enabled_by_default: true
      configurable: false
      scope:
        - "tests/e2e/**/*.{ts,js,spec.ts}"
        - "src/__tests__/**/*.{ts,js}"
      behavior:
        forbidden_patterns:
          - pattern: /\.catch\s*\(\s*\(\s*\)\s*=>\s*(false|null|undefined|{})\s*\)/
            message: "Swallowed error — test will silently pass on failure"
          - pattern: /test\.skip\s*\(\s*true\s*\)/
            message: "Unconditional skip — use test.fixme('Blocked by #XXX') with tracking issue"
          - pattern: /expect\(\w+\)\.toHaveLength\(\d+\)\s*(\/\/.*)?$/m
            message: "Suspicious test — only checks array length, not content"
          - pattern: /\/\/\s*(placeholder|will be enhanced|todo.*later)/i
            message: "Placeholder test — implement real assertions or remove"
        example_violation: |
          test('loads data', async () => {
            const data = await fetch('/api').catch(() => false)
            expect(data).toBeTruthy() // passes even on network error
          })
        example_compliant: |
          test('loads data', async () => {
            const response = await fetch('/api')
            expect(response.ok).toBe(true)
            const data = await response.json()
            expect(data.users).toEqual(expect.arrayContaining([
              expect.objectContaining({ name: expect.any(String) })
            ]))
          })

    - id: TEST-004
      title: "No suspicious test patterns"
      enabled_by_default: true
      configurable: false
      scope:
        - "tests/e2e/**/*.{ts,js,spec.ts}"
        - "src/__tests__/**/*.{ts,js}"
      behavior:
        forbidden_patterns:
          - pattern: /expect\(\w+\)\.toHaveLength\(\d+\)\s*(\/\/.*)?$/m
            message: "Suspicious test — only checks array length, not content. Verify array contents with toEqual or toContain."
          - pattern: /expect\(\w+\)\.toBe\(\d{2,}\)\s*(\/\/.*)?$/m
            message: "Suspicious test — hardcoded expected value with no visible setup. Ensure expected values come from test fixtures or documented constants."
          - pattern: /expect\(\w+\)\.toEqual\(\[\]\)\s*(\/\/.*)?$/m
            message: "Suspicious test — asserts empty array. Verify this is intentional and not masking missing data."
          - pattern: /expect\(\w+\)\.toBeDefined\(\)\s*(\/\/.*)?$/m
            message: "Weak assertion — only checks existence, not correctness. Add specific value checks."
        example_violation: |
          test('loads users', async () => {
            const users = await getUsers()
            expect(users).toHaveLength(3)  // Only checks count, not content
          })
        example_compliant: |
          test('loads users', async () => {
            const users = await getUsers()
            expect(users).toEqual(expect.arrayContaining([
              expect.objectContaining({ name: 'Alice', role: 'admin' })
            ]))
          })

    - id: TEST-005
      title: "No placeholder test markers"
      enabled_by_default: true
      configurable: false
      scope:
        - "tests/e2e/**/*.{ts,js,spec.ts}"
        - "src/__tests__/**/*.{ts,js}"
      behavior:
        forbidden_patterns:
          - pattern: /\/\/\s*placeholder/i
            message: "Placeholder test — implement real assertions or remove"
          - pattern: /\/\/\s*will be enhanced/i
            message: "Deferred test — implement now or create a tracking issue"
          - pattern: /\/\/\s*TODO:?\s*real test/i
            message: "TODO marker for test — implement the real test before merging"
          - pattern: /\/\/\s*TODO:?\s*add (more )?assertions/i
            message: "Missing assertions — add them before merging"
          - pattern: /\/\/\s*FIXME:?\s*test/i
            message: "FIXME in test — resolve before merging"
          - pattern: /test\(['"].*placeholder.*['"]/i
            message: "Test name indicates placeholder — implement real test or remove"
        example_violation: |
          test('user registration', async () => {
            // placeholder — will be enhanced later
            expect(true).toBe(true)
          })
        example_compliant: |
          test('user registration', async () => {
            const response = await register({ email: 'test@example.com', password: 'secure123' })
            expect(response.status).toBe(201)
            expect(response.body.user.email).toBe('test@example.com')
          })

compliance_checklist:
  before_editing_files:
    - question: "Are you adding a mock/stub to an E2E or journey test?"
      if_yes: "STOP. E2E and journey tests must hit real services. Move mock to unit tests."
    - question: "Are you adding try/catch that swallows errors in tests?"
      if_yes: "Use expect().rejects or let the error propagate — tests should fail visibly."
    - question: "Are you skipping a test?"
      if_yes: "Use test.fixme('Blocked by #XXX') — never test.skip(true)."
    - question: "Does your test only check array length or existence?"
      if_yes: "Add content assertions — verify values, not just counts."
    - question: "Does your test contain placeholder comments or TODO markers?"
      if_yes: "Implement real assertions now. If not possible, create a tracking issue and use test.fixme()."

test_hooks:
  tests:
    - file: "src/__tests__/contracts/test_integrity_defaults.test.ts"
      description: "Pattern checks for TEST-001 through TEST-005"
  tooling:
    checker_script: "scripts/check-contracts.js"

# Override mechanism
# Per-project override in .specflow/config.json:
#
# {
#   "contract_defaults": {
#     "test_integrity": {
#       "no_mock_in_e2e": true,
#       "no_mock_in_journey": true,
#       "no_mock_in_unit": false,
#       "allowed_mock_patterns": ["stripe", "twilio"]
#     }
#   }
# }
#
# allowed_mock_patterns: When a forbidden_pattern match contains one of these
# strings, it is exempted. Use for services where real calls have side effects
# (payment processors, SMS providers) that cannot be safely tested.

# Attribution
# No-mock philosophy directly from forge (https://github.com/ikennaokpala/forge)
# by Ikenna N. Okpala: "Every test hits the real API. Mocks hide integration bugs,
# create false confidence, and test implementation details instead of behavior."
# Core thesis from Ikenna's Continuous Behavioral Verification work.
# Silent test anti-patterns from Specflow's own e2e-test-auditor agent,
# production-tested across 280+ issues.
